<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠå°é£ã„å¸³</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
        :root {
            --primary: #FF9AA2;
            --secondary: #B5EAD7;
            --bg: #FFF5F7;
            --text: #4A4A4A;
            --line: #06C755;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 20px 80px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #FF6F61; font-weight: bold; }
        
        /* åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 154, 162, 0.2);
            width: 100%;
            max-width: 350px;
            text-align: center;
            margin-bottom: 20px;
        }
        .points { font-size: 3rem; font-weight: bold; color: var(--primary); line-height: 1; }
        .unit { font-size: 0.9rem; color: #888; margin-top: 5px;}

        /* å ±å‘Šãƒœã‚¿ãƒ³ */
        .report-btn {
            background-color: var(--line);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .report-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ“ä½œ */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px;
            align-items: center;
        }
        .month-label { font-weight:bold; font-size:1.1rem; color: #333; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            width: 100%;
            max-width: 350px;
        }
        .day-header {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            padding-bottom: 5px;
        }
        .day-cell {
            background: white;
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .day-cell:active { transform: scale(0.95); background-color: #f0f0f0; }
        .day-cell.today { border: 2px solid var(--primary); }
        .day-point-dot {
            width: 6px;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 50%;
            margin-top: 2px;
            display: none;
        }
        .day-cell.has-points .day-point-dot { display: block; background-color: var(--primary); }

        .settings-btn {
            margin-top: 30px;
            background: white;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #555;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: white;
            width: 85%;
            max-width: 350px;
            border-radius: 20px;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; padding: 5px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: #FFF5F7;
            padding: 12px;
            border-radius: 12px;
        }
        .checklist-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
            accent-color: var(--primary);
        }
        .task-info { flex-grow: 1; }
        .task-name { font-weight: bold; display: block; font-size: 1rem; }
        .task-pts { font-size: 0.85rem; color: #FF6F61; }

        .setting-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .setting-row input[type="text"] { flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .setting-row input[type="number"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .add-btn { width: 100%; background: var(--secondary); border: none; padding: 12px; border-radius: 10px; color: #333; font-weight: bold; cursor: pointer; margin-top: 10px;}
        .delete-btn { background: #ffcccb; border: none; padding: 0 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .save-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: bold; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h1 id="monthTitle">--æœˆã®ãƒã‚¤ãƒ³ãƒˆ</h1>
    
    <div class="summary-card">
        <div class="points" id="totalPoints">0</div>
        <div class="unit">ãŸã¾ã‚Šã¾ã—ãŸï¼</div>
        <button class="report-btn" onclick="shareWeeklyReport()">
            ğŸ“… 1é€±é–“ã®å ±å‘Šã‚’ã™ã‚‹
        </button>
    </div>

    <div class="calendar-controls">
        <button onclick="changeMonth(-1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â—€</button>
        <div class="month-label" id="currentMonthLabel">loading...</div>
        <button onclick="changeMonth(1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â–¶</button>
    </div>

    <div class="calendar-grid">
        <div class="day-header" style="color:#ff6f61">æ—¥</div><div class="day-header">æœˆ</div><div class="day-header">ç«</div>
        <div class="day-header">æ°´</div><div class="day-header">æœ¨</div><div class="day-header">é‡‘</div><div class="day-header" style="color:#6fa3ff">åœŸ</div>
    </div>
    <div class="calendar-grid" id="calendarDays"></div>

    <button class="settings-btn" onclick="openSettings()">âš™ï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã™ã‚‹</button>

    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('dayModal')">Ã—</button>
            <div class="modal-title" id="selectedDateLabel"></div>
            <div id="taskList"></div>
            <button class="save-btn" onclick="closeModal('dayModal')">OK</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('settingsModal')">Ã—</button>
            <div class="modal-title">é …ç›®ã®è¨­å®š</div>
            <div id="settingsList" class="settings-list"></div>
            <button class="add-btn" onclick="addNewTaskInput()">ï¼‹ æ–°ã—ã„é …ç›®ã‚’è¿½åŠ </button>
            <button class="save-btn" onclick="saveSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let tasks = [];
        let logs = {};
        try {
            tasks = JSON.parse(localStorage.getItem('myTasks')) || [
                { id: 1, name: 'ãŠçš¿æ´—ã„', points: 10 },
                { id: 2, name: 'å®¿é¡Œå®Œäº†', points: 20 },
                { id: 3, name: 'ãŠé¢¨å‘‚æƒé™¤', points: 30 }
            ];
            logs = JSON.parse(localStorage.getItem('myLogs')) || {};
        } catch (e) { console.error("Storage Error", e); }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); 
        let selectedDateStr = "";

        // åˆæœŸåŒ–
        renderCalendar();
        updateTotalPoints();

        // --- é€±æ¬¡å ±å‘Šæ©Ÿèƒ½ï¼ˆè³¢ã„ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ---
        function shareWeeklyReport() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=æ—¥, 1=æœˆ...
            
            // åŸºæº–ã¨ãªã‚‹ã€Œæœˆæ›œæ—¥ã€ã‚’æ±ºã‚ã‚‹
            // æœˆæ›œæ—¥(1)ãªã‚‰ã€å…ˆé€±ã®æœˆæ›œæ—¥(-7æ—¥)ã‚’åŸºæº–ã«ã™ã‚‹
            // ãã‚Œä»¥å¤–ãªã‚‰ã€ä»Šé€±ã®æœˆæ›œæ—¥ã‚’åŸºæº–ã«ã™ã‚‹
            let diffToMonday = 0;
            if (dayOfWeek === 1) { // æœˆæ›œæ—¥ã®å ´åˆ
                diffToMonday = -7;
            } else if (dayOfWeek === 0) { // æ—¥æ›œæ—¥ã®å ´åˆ
                diffToMonday = -6;
            } else { // ç«ã€œåœŸã®å ´åˆ
                diffToMonday = 1 - dayOfWeek;
            }

            const startDate = new Date(today);
            startDate.setDate(today.getDate() + diffToMonday); // æœˆæ›œæ—¥
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // æ—¥æ›œæ—¥

            // æ—¥ä»˜ç¯„å›²ã®æ–‡å­—åˆ—ã‚’ä½œæˆ (YYYY-MM-DD)
            let weeklyTotal = 0;
            let checkDate = new Date(startDate);
            
            // æœˆæ›œã€œæ—¥æ›œã¾ã§ãƒ«ãƒ¼ãƒ—ã—ã¦é›†è¨ˆ
            for(let i=0; i<7; i++) {
                const dStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
                
                if (logs[dStr]) {
                    logs[dStr].forEach(id => {
                        const task = tasks.find(t => t.id === id);
                        if(task) weeklyTotal += task.points;
                    });
                }
                checkDate.setDate(checkDate.getDate() + 1);
            }

            // è¡¨ç¤ºç”¨æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (M/D)
            const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
            const rangeText = `${fmt(startDate)}ã€œ${fmt(endDate)}`;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
            const text = `ãƒ‘ãƒ‘ï¼\nä»Šé€±ï¼ˆ${rangeText}ï¼‰ã®ãŠæ‰‹ä¼ã„ãƒã‚¤ãƒ³ãƒˆã¯\nâœ¨ ã€ ${weeklyTotal}ãƒã‚¤ãƒ³ãƒˆ ã€‘ âœ¨\nãŸã¾ã£ãŸã‚ˆï¼ç¢ºèªã—ã¦ã­ğŸ˜Š`;

            // å…±æœ‰
            if (navigator.share) {
                navigator.share({ title: 'é€±é–“å ±å‘Š', text: text }).catch(console.error);
            } else {
                alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n" + text);
                navigator.clipboard.writeText(text);
            }
        }

        // --- ä»¥ä¸‹ã€åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ ---
        function renderCalendar() {
            document.getElementById('currentMonthLabel').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const container = document.getElementById('calendarDays');
            container.innerHTML = "";
            for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayLog = logs[dateStr] || [];
                const cell = document.createElement('div');
                cell.className = `day-cell ${dayLog.length > 0 ? 'has-points' : ''} ${dateStr === todayStr ? 'today' : ''}`;
                cell.onclick = function() { openDayModal(dateStr, d); };
                
                const dayOfWeek = new Date(currentYear, currentMonth, d).getDay();
                let colorStyle = "";
                if(dayOfWeek === 0) colorStyle = "color:#ff6f61;";
                if(dayOfWeek === 6) colorStyle = "color:#6fa3ff;";

                cell.innerHTML = `<span style="${colorStyle}">${d}</span><div class="day-point-dot"></div>`;
                container.appendChild(cell);
            }
        }

        function changeMonth(diff) {
            currentMonth += diff;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; } 
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar(); updateTotalPoints();
        }

        function updateTotalPoints() {
            let total = 0;
            const targetMonthStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}`;
            Object.keys(logs).forEach(dateStr => {
                if (dateStr.startsWith(targetMonthStr)) {
                    logs[dateStr].forEach(id => {
                        const task = tasks.find(t => t.id === id);
                        if (task) total += parseInt(task.points);
                    });
                }
            });
            document.getElementById('totalPoints').innerText = total;
            document.getElementById('monthTitle').innerText = `${currentMonth + 1}æœˆã®ãƒã‚¤ãƒ³ãƒˆ`;
        }

        function openDayModal(dateStr, dayNum) {
            selectedDateStr = dateStr;
            document.getElementById('selectedDateLabel').innerText = `${currentMonth+1}æœˆ${dayNum}æ—¥ ã®ã‚„ã£ãŸã“ã¨`;
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            const currentLog = logs[dateStr] || [];
            tasks.forEach(task => {
                const isChecked = currentLog.includes(task.id);
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleTask(${task.id}, this.checked)">
                    <div class="task-info"><span class="task-name">${task.name}</span><span class="task-pts">${task.points} P</span></div>
                `;
                container.appendChild(item);
            });
            document.getElementById('dayModal').style.display = 'flex';
        }

        function toggleTask(taskId, isChecked) {
            if (!logs[selectedDateStr]) logs[selectedDateStr] = [];
            if (isChecked) {
                if (!logs[selectedDateStr].includes(taskId)) logs[selectedDateStr].push(taskId);
            } else {
                logs[selectedDateStr] = logs[selectedDateStr].filter(id => id !== taskId);
            }
            localStorage.setItem('myLogs', JSON.stringify(logs));
            updateTotalPoints(); renderCalendar();
        }

        function openSettings() {
            const container = document.getElementById('settingsList');
            container.innerHTML = "";
            tasks.forEach((task) => appendSettingRow(task.name, task.points));
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function appendSettingRow(name = "", points = "") {
            const container = document.getElementById('settingsList');
            const div = document.createElement('div');
            div.className = 'setting-row';
            div.innerHTML = `<input type="text" placeholder="é …ç›®å" value="${name}" class="st-name"><input type="number" placeholder="P" value="${points}" class="st-pts"><button class="delete-btn" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>`;
            container.appendChild(div);
        }

        function addNewTaskInput() { appendSettingRow(); }

        function saveSettings() {
            const rows = document.querySelectorAll('.setting-row');
            const newTasks = [];
            rows.forEach((row, idx) => {
                const name = row.querySelector('.st-name').value;
                const points = row.querySelector('.st-pts').value;
                if (name && points) newTasks.push({ id: Date.now() + idx, name: name, points: parseInt(points) });
            });
            tasks = newTasks;
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            closeModal('settingsModal');
            updateTotalPoints();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
