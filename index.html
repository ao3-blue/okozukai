<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠå°é£ã„å¸³</title>
    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š */
        :root {
            --primary: #FF9AA2;
            --secondary: #B5EAD7;
            --bg: #FFF5F7;
            --text: #4A4A4A;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 20px 80px 20px; /* ä¸‹ã«ä½™ç™½ã‚’è¿½åŠ  */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #FF6F61; }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 154, 162, 0.2);
            width: 100%;
            max-width: 350px;
            text-align: center;
            margin-bottom: 20px;
        }
        .points { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .unit { font-size: 1rem; color: #888; }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px;
            align-items: center;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px; /* ã‚¹ãƒãƒ›ç”¨ã«éš™é–“ã‚’èª¿æ•´ */
            width: 100%;
            max-width: 350px;
        }
        .day-header {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            padding-bottom: 5px;
        }
        .day-cell {
            background: white;
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .day-cell:active { transform: scale(0.95); background-color: #f0f0f0; }
        .day-cell.today { border: 2px solid var(--primary); }
        .day-point-dot {
            width: 6px;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 50%;
            margin-top: 2px;
            display: none;
        }
        .day-cell.has-points .day-point-dot { display: block; background-color: var(--primary); }

        .settings-btn {
            margin-top: 30px;
            background: white;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* é‡ãªã‚Šé †ã‚’æœ€å‰é¢ã« */
            backdrop-filter: blur(2px);
        }
        .modal {
            background: white;
            width: 85%;
            max-width: 350px;
            border-radius: 20px;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; padding: 5px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: #FFF5F7;
            padding: 12px;
            border-radius: 12px;
        }
        .checklist-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
            accent-color: var(--primary);
        }
        .task-info { flex-grow: 1; }
        .task-name { font-weight: bold; display: block; font-size: 1rem; }
        .task-pts { font-size: 0.85rem; color: #FF6F61; }

        .setting-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .setting-row input[type="text"] { flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; /* ã‚ºãƒ¼ãƒ é˜²æ­¢ */ }
        .setting-row input[type="number"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .add-btn { width: 100%; background: var(--secondary); border: none; padding: 12px; border-radius: 10px; color: #333; font-weight: bold; cursor: pointer; margin-top: 10px;}
        .delete-btn { background: #ffcccb; border: none; padding: 0 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .save-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: bold; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>ä»Šæœˆã®ãƒã‚¤ãƒ³ãƒˆ</h1>
    <div class="summary-card">
        <div class="points" id="totalPoints">0</div>
        <div class="unit">ãƒã‚¤ãƒ³ãƒˆ</div>
    </div>

    <div class="calendar-controls">
        <button onclick="changeMonth(-1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â—€</button>
        <div style="font-weight:bold; font-size:1.1rem;" id="currentMonthLabel">loading...</div>
        <button onclick="changeMonth(1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â–¶</button>
    </div>

    <div class="calendar-grid">
        <div class="day-header" style="color:#ff6f61">æ—¥</div><div class="day-header">æœˆ</div><div class="day-header">ç«</div>
        <div class="day-header">æ°´</div><div class="day-header">æœ¨</div><div class="day-header">é‡‘</div><div class="day-header" style="color:#6fa3ff">åœŸ</div>
    </div>
    <div class="calendar-grid" id="calendarDays"></div>

    <button class="settings-btn" onclick="openSettings()">âš™ï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã™ã‚‹</button>

    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('dayModal')">Ã—</button>
            <div class="modal-title" id="selectedDateLabel"></div>
            <div id="taskList"></div>
            <button class="save-btn" onclick="closeModal('dayModal')">OK</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('settingsModal')">Ã—</button>
            <div class="modal-title">é …ç›®ã®è¨­å®š</div>
            <div id="settingsList" class="settings-list"></div>
            <button class="add-btn" onclick="addNewTaskInput()">ï¼‹ æ–°ã—ã„é …ç›®ã‚’è¿½åŠ </button>
            <button class="save-btn" onclick="saveSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        let tasks = [];
        let logs = {};
        try {
            tasks = JSON.parse(localStorage.getItem('myTasks')) || [
                { id: 1, name: 'ãŠçš¿æ´—ã„', points: 10 },
                { id: 2, name: 'å®¿é¡Œå®Œäº†', points: 20 },
                { id: 3, name: 'ãŠé¢¨å‘‚æƒé™¤', points: 30 }
            ];
            logs = JSON.parse(localStorage.getItem('myLogs')) || {};
        } catch (e) {
            console.error("Storage Error", e);
            alert("ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¿å­˜ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
        }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0å§‹ã¾ã‚Š (0=1æœˆ)
        let selectedDateStr = "";

        // åˆæœŸå®Ÿè¡Œ
        renderCalendar();
        updateTotalPoints();

        function renderCalendar() {
            // ãƒ©ãƒ™ãƒ«æ›´æ–°
            document.getElementById('currentMonthLabel').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const container = document.getElementById('calendarDays');
            container.innerHTML = "";

            // ç©ºç™½ã‚»ãƒ«
            for(let i=0; i<firstDay; i++) {
                container.innerHTML += `<div></div>`;
            }

            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæ–‡å­—åˆ—æ¯”è¼ƒç”¨ï¼‰
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            // æ—¥ä»˜ã‚»ãƒ«ç”Ÿæˆ
            for(let d=1; d<=lastDate; d++) {
                // ã‚­ãƒ¼ã¨ã—ã¦ã®æ–‡å­—åˆ—ç”Ÿæˆ (YYYY-MM-DD)
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                
                const dayLog = logs[dateStr] || [];
                const hasPoints = dayLog.length > 0;
                const isToday = (dateStr === todayStr);

                const cell = document.createElement('div');
                cell.className = `day-cell ${hasPoints ? 'has-points' : ''} ${isToday ? 'today' : ''}`;
                cell.onclick = function() { openDayModal(dateStr, d); }; // iPhoneå¯¾å¿œ: é–¢æ•°ã§åŒ…ã‚€
                
                // åœŸæ—¥ã®è‰²ä»˜ã‘
                const dayOfWeek = new Date(currentYear, currentMonth, d).getDay();
                let colorStyle = "";
                if(dayOfWeek === 0) colorStyle = "color:#ff6f61;"; // æ—¥
                if(dayOfWeek === 6) colorStyle = "color:#6fa3ff;"; // åœŸ

                cell.innerHTML = `
                    <span style="${colorStyle}">${d}</span>
                    <div class="day-point-dot"></div>
                `;
                container.appendChild(cell);
            }
        }

        function changeMonth(diff) {
            currentMonth += diff;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            updateTotalPoints();
        }

        function openDayModal(dateStr, dayNum) {
            selectedDateStr = dateStr;
            document.getElementById('selectedDateLabel').innerText = `${currentMonth+1}æœˆ${dayNum}æ—¥ ã®ã‚„ã£ãŸã“ã¨`;
            
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            
            const currentLog = logs[dateStr] || [];

            tasks.forEach(task => {
                const isChecked = currentLog.includes(task.id);
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleTask(${task.id}, this.checked)">
                    <div class="task-info">
                        <span class="task-name">${task.name}</span>
                        <span class="task-pts">${task.points} P</span>
                    </div>
                `;
                container.appendChild(item);
            });

            document.getElementById('dayModal').style.display = 'flex';
        }

        function toggleTask(taskId, isChecked) {
            if (!logs[selectedDateStr]) logs[selectedDateStr] = [];
            
            if (isChecked) {
                if (!logs[selectedDateStr].includes(taskId)) {
                    logs[selectedDateStr].push(taskId);
                }
            } else {
                logs[selectedDateStr] = logs[selectedDateStr].filter(id => id !== taskId);
            }
            
            saveToStorage();
            updateTotalPoints();
            renderCalendar();
        }

        function updateTotalPoints() {
            let total = 0;
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆã®åˆè¨ˆã‚’è¨ˆç®—
            // æ–‡å­—åˆ—ãƒãƒƒãƒãƒ³ã‚°ã§è¨ˆç®—ã™ã‚‹ï¼ˆæ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ã«ã‚ˆã‚‹ãƒã‚°å›é¿ï¼‰
            const prefix = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}`;

            for (let dateKey in logs) {
                if (dateKey.startsWith(prefix)) {
                    const taskIds = logs[dateKey];
                    taskIds.forEach(id => {
                        const task = tasks.find(t => t.id === id);
                        if (task) total += parseInt(task.points);
                    });
                }
            }
            document.getElementById('totalPoints').innerText = total;
        }

        // è¨­å®šé–¢é€£
        function openSettings() {
            const container = document.getElementById('settingsList');
            container.innerHTML = "";
            tasks.forEach((task, index) => {
                appendSettingRow(task.name, task.points);
            });
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function appendSettingRow(name = "", points = "") {
            const container = document.getElementById('settingsList');
            const div = document.createElement('div');
            div.className = 'setting-row';
            div.innerHTML = `
                <input type="text" placeholder="é …ç›®å" value="${name}" class="st-name">
                <input type="number" placeholder="P" value="${points}" class="st-pts">
                <button class="delete-btn" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
            `;
            container.appendChild(div);
        }

        function addNewTaskInput() { appendSettingRow(); }

        function saveSettings() {
            const rows = document.querySelectorAll('.setting-row');
            const newTasks = [];
            rows.forEach((row, idx) => {
                const name = row.querySelector('.st-name').value;
                const points = row.querySelector('.st-pts').value;
                if (name && points) {
                    newTasks.push({
                        id: Date.now() + idx,
                        name: name,
                        points: parseInt(points)
                    });
                }
            });
            tasks = newTasks;
            saveToStorage('myTasks', tasks); // ã‚¿ã‚¹ã‚¯ä¿å­˜æ™‚ã¯ã‚­ãƒ¼æŒ‡å®šãŒå¿…è¦ã§ã™ãŒã€å…±é€šé–¢æ•°ã‚’ä½¿ã†ãŸã‚
            localStorage.setItem('myTasks', JSON.stringify(tasks)); // æ˜ç¤ºçš„ã«ä¿å­˜
            
            closeModal('settingsModal');
            updateTotalPoints();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('myLogs', JSON.stringify(logs));
            } catch(e) {
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰");
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>
