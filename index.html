<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠå°é£ã„å¸³</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
        :root {
            --primary: #FF9AA2; /* ãƒ”ãƒ³ã‚¯ */
            --secondary: #B5EAD7; /* ã‚°ãƒªãƒ¼ãƒ³ */
            --bg: #FFF5F7;
            --text: #4A4A4A;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 20px 80px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ« */
        h1 { 
            font-size: 1.2rem; 
            margin-bottom: 10px; 
            color: #FF6F61; 
            font-weight: bold;
        }
        
        /* åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 154, 162, 0.2);
            width: 100%;
            max-width: 350px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .points { font-size: 3rem; font-weight: bold; color: var(--primary); line-height: 1; }
        .unit { font-size: 0.9rem; color: #888; margin-top: 5px;}

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ“ä½œã‚¨ãƒªã‚¢ */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
            margin-bottom: 15px;
            align-items: center;
        }
        .month-label { font-weight:bold; font-size:1.1rem; color: #333; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            width: 100%;
            max-width: 350px;
        }
        .day-header {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            padding-bottom: 5px;
        }
        .day-cell {
            background: white;
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .day-cell:active { transform: scale(0.95); background-color: #f0f0f0; }
        .day-cell.today { border: 2px solid var(--primary); }
        
        /* ãƒ‰ãƒƒãƒˆï¼ˆã‚„ã£ãŸã“ã¨ã‚ã‚‹æ—¥ï¼‰ */
        .day-point-dot {
            width: 6px;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 50%;
            margin-top: 2px;
            display: none;
        }
        .day-cell.has-points .day-point-dot { display: block; background-color: var(--primary); }

        /* è¨­å®šãƒœã‚¿ãƒ³ */
        .settings-btn {
            margin-top: 30px;
            background: white;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #555;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: white;
            width: 85%;
            max-width: 350px;
            border-radius: 20px;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; padding: 5px;
        }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: #FFF5F7;
            padding: 12px;
            border-radius: 12px;
        }
        .checklist-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
            accent-color: var(--primary);
        }
        .task-info { flex-grow: 1; }
        .task-name { font-weight: bold; display: block; font-size: 1rem; }
        .task-pts { font-size: 0.85rem; color: #FF6F61; }

        /* è¨­å®šç”»é¢ */
        .setting-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .setting-row input[type="text"] { flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .setting-row input[type="number"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .add-btn { width: 100%; background: var(--secondary); border: none; padding: 12px; border-radius: 10px; color: #333; font-weight: bold; cursor: pointer; margin-top: 10px;}
        .delete-btn { background: #ffcccb; border: none; padding: 0 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .save-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: bold; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h1 id="monthTitle">--æœˆã®ãƒã‚¤ãƒ³ãƒˆ</h1>
    
    <div class="summary-card">
        <div class="points" id="totalPoints">0</div>
        <div class="unit">ãŸã¾ã‚Šã¾ã—ãŸï¼</div>
    </div>

    <div class="calendar-controls">
        <button onclick="changeMonth(-1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â—€</button>
        <div class="month-label" id="currentMonthLabel">loading...</div>
        <button onclick="changeMonth(1)" style="background:none; border:none; font-size:1.5rem; padding:10px;">â–¶</button>
    </div>

    <div class="calendar-grid">
        <div class="day-header" style="color:#ff6f61">æ—¥</div><div class="day-header">æœˆ</div><div class="day-header">ç«</div>
        <div class="day-header">æ°´</div><div class="day-header">æœ¨</div><div class="day-header">é‡‘</div><div class="day-header" style="color:#6fa3ff">åœŸ</div>
    </div>
    <div class="calendar-grid" id="calendarDays"></div>

    <button class="settings-btn" onclick="openSettings()">âš™ï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã™ã‚‹</button>

    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('dayModal')">Ã—</button>
            <div class="modal-title" id="selectedDateLabel"></div>
            <div id="taskList"></div>
            <button class="save-btn" onclick="closeModal('dayModal')">OK</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal('settingsModal')">Ã—</button>
            <div class="modal-title">é …ç›®ã®è¨­å®š</div>
            <div id="settingsList" class="settings-list"></div>
            <button class="add-btn" onclick="addNewTaskInput()">ï¼‹ æ–°ã—ã„é …ç›®ã‚’è¿½åŠ </button>
            <button class="save-btn" onclick="saveSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
        let tasks = [];
        let logs = {};
        try {
            tasks = JSON.parse(localStorage.getItem('myTasks')) || [
                { id: 1, name: 'ãŠçš¿æ´—ã„', points: 10 },
                { id: 2, name: 'å®¿é¡Œå®Œäº†', points: 20 },
                { id: 3, name: 'ãŠé¢¨å‘‚æƒé™¤', points: 30 }
            ];
            logs = JSON.parse(localStorage.getItem('myLogs')) || {};
        } catch (e) {
            console.error("Storage Error", e);
        }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0=1æœˆ
        let selectedDateStr = "";

        // æœ€åˆã«å®Ÿè¡Œ
        renderCalendar();
        updateTotalPoints();

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ---
        function renderCalendar() {
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸Šã®å¹´æœˆè¡¨ç¤º
            document.getElementById('currentMonthLabel').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const container = document.getElementById('calendarDays');
            container.innerHTML = "";

            // ç©ºç™½ã‚»ãƒ«
            for(let i=0; i<firstDay; i++) {
                container.innerHTML += `<div></div>`;
            }

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                
                const dayLog = logs[dateStr] || [];
                const hasPoints = dayLog.length > 0;
                const isToday = (dateStr === todayStr);

                const cell = document.createElement('div');
                cell.className = `day-cell ${hasPoints ? 'has-points' : ''} ${isToday ? 'today' : ''}`;
                
                // iPhoneå¯¾å¿œ: onclickã‚’é–¢æ•°ã§ãƒ©ãƒƒãƒ—
                cell.onclick = function() { openDayModal(dateStr, d); }; 
                
                // åœŸæ—¥ã®è‰²
                const dayOfWeek = new Date(currentYear, currentMonth, d).getDay();
                let colorStyle = "";
                if(dayOfWeek === 0) colorStyle = "color:#ff6f61;"; // æ—¥
                if(dayOfWeek === 6) colorStyle = "color:#6fa3ff;"; // åœŸ

                cell.innerHTML = `
                    <span style="${colorStyle}">${d}</span>
                    <div class="day-point-dot"></div>
                `;
                container.appendChild(cell);
            }
        }

        // --- æœˆã‚’å¤‰ãˆã‚‹ ---
        function changeMonth(diff) {
            currentMonth += diff;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();     // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›¸ãç›´ã™
            updateTotalPoints();  // åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚‚å†è¨ˆç®—ã™ã‚‹
        }

        // --- ãƒã‚¤ãƒ³ãƒˆé›†è¨ˆï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰ ---
        function updateTotalPoints() {
            let total = 0;
            
            // "2024-01" ã®ã‚ˆã†ãªã€Œå¹´æœˆã€ã®æ–‡å­—ã‚’ä½œã‚‹
            const targetMonthStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}`;

            // ã™ã¹ã¦ã®è¨˜éŒ²ã‚’è¦‹ã¦ã€ä»Šæœˆã®ã‚‚ã®ã ã‘è¶³ã—ç®—ã™ã‚‹
            Object.keys(logs).forEach(dateStr => {
                if (dateStr.startsWith(targetMonthStr)) {
                    // æ—¥ä»˜ãŒä»Šæœˆã¨ä¸€è‡´ã—ãŸã‚‰ã€ãã®æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’å…¨éƒ¨è¶³ã™
                    const taskIds = logs[dateStr];
                    taskIds.forEach(id => {
                        const task = tasks.find(t => t.id === id);
                        if (task) total += parseInt(task.points);
                    });
                }
            });

            // ç”»é¢ã«è¡¨ç¤º
            document.getElementById('totalPoints').innerText = total;
            document.getElementById('monthTitle').innerText = `${currentMonth + 1}æœˆã®ãƒã‚¤ãƒ³ãƒˆ`;
        }

        // --- æ—¥åˆ¥ã®å…¥åŠ›ç”»é¢ã‚’é–‹ã ---
        function openDayModal(dateStr, dayNum) {
            selectedDateStr = dateStr;
            document.getElementById('selectedDateLabel').innerText = `${currentMonth+1}æœˆ${dayNum}æ—¥ ã®ã‚„ã£ãŸã“ã¨`;
            
            const container = document.getElementById('taskList');
            container.innerHTML = "";
            
            const currentLog = logs[dateStr] || [];

            tasks.forEach(task => {
                const isChecked = currentLog.includes(task.id);
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleTask(${task.id}, this.checked)">
                    <div class="task-info">
                        <span class="task-name">${task.name}</span>
                        <span class="task-pts">${task.points} P</span>
                    </div>
                `;
                container.appendChild(item);
            });

            document.getElementById('dayModal').style.display = 'flex';
        }

        function toggleTask(taskId, isChecked) {
            if (!logs[selectedDateStr]) logs[selectedDateStr] = [];
            
            if (isChecked) {
                if (!logs[selectedDateStr].includes(taskId)) {
                    logs[selectedDateStr].push(taskId);
                }
            } else {
                logs[selectedDateStr] = logs[selectedDateStr].filter(id => id !== taskId);
            }
            
            localStorage.setItem('myLogs', JSON.stringify(logs));
            updateTotalPoints(); // ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‰å³åº§ã«åˆè¨ˆã‚’æ›´æ–°
            renderCalendar();    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒ‰ãƒƒãƒˆã‚‚æ›´æ–°
        }

        // --- è¨­å®šç”»é¢ ---
        function openSettings() {
            const container = document.getElementById('settingsList');
            container.innerHTML = "";
            tasks.forEach((task, index) => {
                appendSettingRow(task.name, task.points);
            });
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function appendSettingRow(name = "", points = "") {
            const container = document.getElementById('settingsList');
            const div = document.createElement('div');
            div.className = 'setting-row';
            div.innerHTML = `
                <input type="text" placeholder="é …ç›®å" value="${name}" class="st-name">
                <input type="number" placeholder="P" value="${points}" class="st-pts">
                <button class="delete-btn" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
            `;
            container.appendChild(div);
        }

        function addNewTaskInput() { appendSettingRow(); }

        function saveSettings() {
            const rows = document.querySelectorAll('.setting-row');
            const newTasks = [];
            rows.forEach((row, idx) => {
                const name = row.querySelector('.st-name').value;
                const points = row.querySelector('.st-pts').value;
                if (name && points) {
                    newTasks.push({
                        id: Date.now() + idx,
                        name: name,
                        points: parseInt(points)
                    });
                }
            });
            tasks = newTasks;
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            closeModal('settingsModal');
            updateTotalPoints();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>
</html>
